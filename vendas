import pandas as pd

# Função para processar os chunks carregando 100000 linhas do arquivo
def processar_vendas_em_chunks(vendas.csv, chunk_size=100000):
    # Inicializando variáveis para armazenar resultados parciais
    total_vendas_produto = {}
    total_vendas_loja = {}
    vendas_mensais = {}

    # Lendo o arquivo em chunks
    for chunk in pd.read_csv(vendas.csv, chunksize=chunk_size):
        # Processando o chunk: calculando o valor da venda (Quantidade * Preço_Unitário)
        chunk['Valor_Venda'] = chunk['Quantidade'] * chunk['Preco_Unitario']

        # Agregando por produto
        vendas_produto_chunk = chunk.groupby('Produto')['Quantidade'].sum()
        for produto, qtd in vendas_produto_chunk.items():
            if produto in total_vendas_produto:
                total_vendas_produto[produto] += qtd
            else:
                total_vendas_produto[produto] = qtd

        # Agregando por país
        vendas_loja_chunk = chunk.groupby('Pais')['Valor_Venda'].sum()
        for pais, valor in vendas_loja_chunk.items():
            if pais in total_vendas_loja:
                total_vendas_loja[pais] += valor
            else:
                total_vendas_loja[pais] = valor

        # Calculando vendas mensais
        chunk['Data'] = pd.to_datetime(chunk['Data'])
        chunk['Mes'] = chunk['Data'].dt.to_period('M')
        vendas_mensais_chunk = chunk.groupby(['Produto', 'Mes'])['Valor_Venda'].sum()
        for (produto, mes), valor in vendas_mensais_chunk.items():
            if produto not in vendas_mensais:
                vendas_mensais[produto] = {}
            if mes not in vendas_mensais[produto]:
                vendas_mensais[produto][mes] = valor
            else:
                vendas_mensais[produto][mes] += valor

    # Convertendo vendas mensais em média mensal por produto
    media_vendas_mensais = {
        produto: sum(valores.values()) / len(valores)
        for produto, valores in vendas_mensais.items()
    }

    return total_vendas_produto, total_vendas_loja, media_vendas_mensais


# Função principal para executar o processamento
def main():
    arquivo_csv = 'vendas.csv'
    
    # Processar vendas em chunks
    total_vendas_produto, total_vendas_loja, media_vendas_mensais = processar_vendas_em_chunks(vendas.csv)

    # Produto mais vendido
    produto_mais_vendido = max(total_vendas_produto, key=total_vendas_produto.get)
    print(f"Produto mais vendido: {produto_mais_vendido} ({total_vendas_produto[produto_mais_vendido]} unidades)")

    # País com maior volume de vendas
    loja_maior_venda = max(total_vendas_loja, key=total_vendas_loja.get)
    print(f"País com maior volume de vendas: {loja_maior_venda} (R$ {total_vendas_loja[loja_maior_venda]:.2f})")

    # Média de vendas mensais por produto
    for produto, media in media_vendas_mensais.items():
        print(f"Média de vendas mensais do produto {produto}: R$ {media:.2f}")


if __name__ == '__main__':
    main()
